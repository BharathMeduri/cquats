#!/bin/bash
# menuconfig
# 
# Quick Description:
# Part of the CQUATS - C QA ToolSet - project
# 
# CQuATS Configuration Menu System.
# Menu is based on the opensource Kbuild system;
# initial template sourced from here:
#  https://github.com/masahir0y/kbuild_skeleton
# All credit to the original devs.
#
# Last Updated : 15Nov2017
# Created      : 14Nov2017
# License: GPLv2
name=$(basename $0)
PFX=$(dirname $(which $0))
source ${PFX}/common.sh || {
 echo "${name}: fatal: could not source ${PFX}/common.sh , aborting..."
 exit 1
} |tee -a ${LOGFILE_COMMON}
source ${PFX}/cquats_common.sh || {
 echo "${name}: fatal: could not source ${PFX}/cquats_common.sh , aborting..."
 exit 1
} |tee -a ${LOGFILE_COMMON}

#id
#pwd

###
### We ASSUME that CQuATS is now installed in ${INSTDIR}/
### and is ready to run.
###

### First local run
[ ! -d ${gCQUATS_SCRATCH_FOLDER} ] && {
  echo "[+] ${gPRJ} :: first-time-run detected :: mode: ${MODE}"
  echo "
Note: this folder - $(pwd) - will
become your CQuATS Workspace. 
 (Of course, you are free to setup multiple CQuATS workspaces by running this
  program from different folders).

Proceed? [y/N]
"
  read re
  [ "${re}" != "y" -a "${re}" != "Y" ] && {
    echo "CQuATS now aborting.."
	exit 1
  }
  mkdir -p ${gCQUATS_SCRATCH_FOLDER} #2>/dev/null

[ 0 -eq 1 ] && {
  cd ${MENUDIR} || exit 1
  #cd kbuild || exit 1
  # mconf is the binary executable used for the 'menuconfig' target
  rm -f ${MENUDIR}/.config*
  make distclean   #mrproper
  rm -f scripts/kconfig/mconf #../.first
}
} |tee -a ${LOGFILE_COMMON}
#########


### NOT the first local run
{
check_deps "gcc make"  #perf spatch xterm"

# Running the 'make menuconfig' in a subshell seems to help
cd ${MENUDIR}
echo "${gPRJ}:${name}: menu system loading, pl wait ..."
# The env var UCONFDIR holds the destination folder for the .config
# file generated by kbuild/Makefile; this way, we get 'multiuser' support;
# each user can generate his private .config in his 'cquats' workspace!
UCONFDIR=${LOCAL_INSTDIR} make menuconfig
} #|tee -a ${LOGFILE_COMMON}

exit 0
